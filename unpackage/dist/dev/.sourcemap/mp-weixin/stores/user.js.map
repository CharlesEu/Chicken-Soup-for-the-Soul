{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["import {ref} from \"vue\"\nimport { defineStore } from 'pinia';\nconst uniIdCo = uniCloud.importObject(\"uni-id-co\")\nconst db = uniCloud.database();\nconst usersTable = db.collection('uni-id-users')\n\nexport const useUserStore = defineStore(\"user\",()=>{\n\tlet hostUserInfo = uni.getStorageSync('uni-id-pages-userInfo')||{}\n\tconst userInfo = ref(hostUserInfo);\n\tconst hasLogin= ref(Object.keys(hostUserInfo).length != 0);\n\t\n\t\n\t// data不为空，表示传递要更新的值(注意不是覆盖是合并),什么也不传时，直接查库获取更新\n\tasync function updateUserInfo(data = false) {\n\t\tif (data) {\n\t\t\tusersTable.where('_id==$env.uid').update(data).then(e => {\n\t\t\t\t// console.log(e);\n\t\t\t\tif (e.result.updated) {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: \"更新成功\",\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 3000\n\t\t\t\t\t});\n\t\t\t\t\tsetUserInfo(data)\n\t\t\t\t} else {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: \"没有改变\",\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 3000\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\n\t\t} else {\n\t\t\tconst uniIdCo = uniCloud.importObject(\"uni-id-co\", {\n\t\t\t\tcustomUI: true\n\t\t\t})\n\t\t\ttry {\n\t\t\t\tlet res = await usersTable.where(\"'_id' == $cloudEnv_uid\")\n\t\t\t\t.field('mobile,username,email,avatar,wx_openid.mp as openid,register_date')\n\t\t\t\t.get()\n\t\n\t\t\t\tconst realNameRes = await uniIdCo.getRealNameInfo()\n\t\n\t\t\t\t// console.log('fromDbData',res.result.data);\n\t\t\t\tsetUserInfo({\n\t\t\t\t\t...res.result.data[0],\n\t\t\t\t\trealNameAuth: realNameRes\n\t\t\t\t})\n\t\t\t} catch (e) {\n\t\t\t\tsetUserInfo({},{cover:true})\n\t\t\t\tconsole.error(e.message, e.errCode);\n\t\t\t}\n\t\t}\n\t}\n\t\n\t\n\tasync function setUserInfo(data, {cover}={cover:false}) {\n\t\t// console.log('set-userInfo', data);\n\t\tlet _userInfo = cover?data:Object.assign(userInfo.value,data)\n\t\tuserInfo.value = Object.assign({},_userInfo)\n\t\thasLogin.value = Object.keys(userInfo.value).length != 0\n\t\t// console.log('store.userInfo', store.userInfo);\n\t\tuni.setStorageSync('uni-id-pages-userInfo', userInfo.value)\n\t\treturn data\n\t}\n\t\n\t\n\tasync function logout() {\n\t\t// 1. 已经过期就不需要调用服务端的注销接口\t2.即使调用注销接口失败，不能阻塞客户端\n\t\tif(uniCloud.getCurrentUserInfo().tokenExpired > Date.now()){\n\t\t\ttry{\n\t\t\t\tawait uniIdCo.logout()\n\t\t\t}catch(e){\n\t\t\t\tconsole.error(e);\n\t\t\t}\n\t\t}\n\t\tuni.removeStorageSync('uni_id_token');\n\t\tuni.setStorageSync('uni_id_token_expired', 0)\t\t\n\t\tuni.$emit('uni-id-pages-logout')\n\t\tsetUserInfo({},{cover:true})\n\t}\n\t\n\t//登录后的操作\n\tfunction loginSuccess(e = {}){\n\t\tconst {\n\t\t\tshowToast = true, toastText = '登录成功', autoBack = true, uniIdRedirectUrl = '', passwordConfirmed\n\t\t} = e\n\t\t// console.log({toastText,autoBack});\n\t\tif (showToast) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: toastText,\n\t\t\t\ticon: 'none',\n\t\t\t\tduration: 3000\n\t\t\t});\n\t\t}\n\t\tupdateUserInfo()\t\n\t\tuni.$emit('uni-id-pages-login-success')\t\n\t\t\n\t\tif (autoBack) {\n\t\t\tloginBack({uniIdRedirectUrl})\n\t\t}\n\t}\n\t\n\t\n\t\n\t\n\tfunction loginBack (e = {}) {\n\t\tconst {uniIdRedirectUrl = ''} = e\n\t\tlet delta = 0; //判断需要返回几层\n\t\tlet pages = getCurrentPages();\n\t\t// console.log(pages);\n\t\tpages.forEach((page, index) => {\n\t\t\tif (pages[pages.length - index - 1].route.split('/')[3] == 'login') {\n\t\t\t\tdelta++\n\t\t\t}\n\t\t})\n\t\t// console.log('判断需要返回几层:', delta);\n\t\tif (uniIdRedirectUrl) {\n\t\t\treturn uni.redirectTo({\n\t\t\t\turl: uniIdRedirectUrl,\n\t\t\t\tfail: (err1) => {\n\t\t\t\t\tuni.switchTab({\n\t\t\t\t\t\turl:uniIdRedirectUrl,\n\t\t\t\t\t\tfail: (err2) => {\n\t\t\t\t\t\t\tconsole.log(err1,err2)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t\t// #ifdef H5\n\t\tif (e.loginType == 'weixin') {\n\t\t\t// console.log('window.history', window.history);\n\t\t\treturn window.history.go(-3)\n\t\t}\n\t\t// #endif\n\t\n\t\tif (delta) {\n\t\t\tconst page = pagesJson.pages[0]\n\t\t\treturn uni.reLaunch({\n\t\t\t\turl: `/${page.path}`\n\t\t\t})\n\t\t}\n\t\n\t\tuni.navigateBack({\n\t\t\tdelta\n\t\t})\n\t}\n\t\n\t\n\t\n\t\t\t\n\treturn {userInfo,hasLogin,loginSuccess,updateUserInfo,logout}\n})\n"],"names":["uniCloud","defineStore","uni","ref","uniIdCo"],"mappings":"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"}