{"version":3,"file":"utils.js","sources":["uni_modules/lime-painter/components/l-painter/utils.js"],"sourcesContent":["export const networkReg = /^(http|\\/\\/)/;\nexport const isBase64 = (path) => /^data:image\\/(\\w+);base64/.test(path);\nexport function sleep(delay) {\n\treturn new Promise(resolve => setTimeout(resolve, delay))\n}\nlet {platform, SDKVersion} = uni.getSystemInfoSync() \nexport const isPC = /windows|mac/.test(platform)\n// 缓存图片\nlet cache = {}\nexport function isNumber(value) {\n\treturn /^-?\\d+(\\.\\d+)?$/.test(value);\n}\nexport function toPx(value, baseSize, isDecimal = false) {\n\t// 如果是数字\n\tif (typeof value === 'number') {\n\t\treturn value\n\t}\n\t// 如果是字符串数字\n\tif (isNumber(value)) {\n\t\treturn value * 1\n\t}\n\t// 如果有单位\n\tif (typeof value === 'string') {\n\t\tconst reg = /^-?([0-9]+)?([.]{1}[0-9]+){0,1}(em|rpx|px|%)$/g\n\t\tconst results = reg.exec(value);\n\t\tif (!value || !results) {\n\t\t\treturn 0;\n\t\t}\n\t\tconst unit = results[3];\n\t\tvalue = parseFloat(value);\n\t\tlet res = 0;\n\t\tif (unit === 'rpx') {\n\t\t\tres = uni.upx2px(value);\n\t\t} else if (unit === 'px') {\n\t\t\tres = value * 1;\n\t\t} else if (unit === '%') {\n\t\t\tres = value * toPx(baseSize) / 100;\n\t\t} else if (unit === 'em') {\n\t\t\tres = value * toPx(baseSize || 14);\n\t\t}\n\t\treturn isDecimal ? res.toFixed(2) * 1 : Math.round(res);\n\t}\n\treturn 0\n}\n\n// 计算版本\nexport function compareVersion(v1, v2) {\n\tv1 = v1.split('.')\n\tv2 = v2.split('.')\n\tconst len = Math.max(v1.length, v2.length)\n\twhile (v1.length < len) {\n\t\tv1.push('0')\n\t}\n\twhile (v2.length < len) {\n\t\tv2.push('0')\n\t}\n\tfor (let i = 0; i < len; i++) {\n\t\tconst num1 = parseInt(v1[i], 10)\n\t\tconst num2 = parseInt(v2[i], 10)\n\n\t\tif (num1 > num2) {\n\t\t\treturn 1\n\t\t} else if (num1 < num2) {\n\t\t\treturn -1\n\t\t}\n\t}\n\treturn 0\n}\n\nfunction gte(version) {\n  // #ifdef MP-ALIPAY\n  SDKVersion = my.SDKVersion\n  // #endif\n  return compareVersion(SDKVersion, version) >= 0;\n}\nexport function canIUseCanvas2d() {\n\t// #ifdef MP-WEIXIN\n\treturn gte('2.9.2');\n\t// #endif\n\t// #ifdef MP-ALIPAY\n\treturn gte('2.7.15');\n\t// #endif\n\t// #ifdef MP-TOUTIAO\n\treturn gte('1.78.0');\n\t// #endif\n\treturn false\n}\n\n// #ifdef MP\nexport const prefix = () => {\n\t// #ifdef MP-TOUTIAO\n\treturn tt\n\t// #endif\n\t// #ifdef MP-WEIXIN\n\treturn wx\n\t// #endif\n\t// #ifdef MP-BAIDU\n\treturn swan\n\t// #endif\n\t// #ifdef MP-ALIPAY\n\treturn my\n\t// #endif\n\t// #ifdef MP-QQ\n\treturn qq\n\t// #endif\n\t// #ifdef MP-360\n\treturn qh\n\t// #endif\n}\n// #endif\n\n\n\n/**\n * base64转路径\n * @param {Object} base64\n */\nexport function base64ToPath(base64) {\n\tconst [, format] = /^data:image\\/(\\w+);base64,/.exec(base64) || [];\n\n\treturn new Promise((resolve, reject) => {\n\t\t// #ifdef MP\n\t\tconst fs = uni.getFileSystemManager()\n\t\t//自定义文件名\n\t\tif (!format) {\n\t\t\treject(new Error('ERROR_BASE64SRC_PARSE'))\n\t\t}\n\t\tconst time = new Date().getTime();\n\t\tlet pre = prefix()\n\t\t// #ifdef MP-TOUTIAO\n\t\tconst filePath = `${pre.getEnvInfoSync().common.USER_DATA_PATH}/${time}.${format}`\n\t\t// #endif\n\t\t// #ifndef MP-TOUTIAO\n\t\tconst filePath = `${pre.env.USER_DATA_PATH}/${time}.${format}`\n\t\t// #endif\n\t\tfs.writeFile({\n\t\t\tfilePath,\n\t\t\tdata: base64.split(',')[1],\n\t\t\tencoding: 'base64',\n\t\t\tsuccess() {\n\t\t\t\tresolve(filePath)\n\t\t\t},\n\t\t\tfail(err) {\n\t\t\t\tconsole.error(err)\n\t\t\t\treject(err)\n\t\t\t}\n\t\t})\n\t\t// #endif\n\n\t\t// #ifdef H5\n\t\t// mime类型\n\t\tlet mimeString = base64.split(',')[0].split(':')[1].split(';')[0];\n\t\t//base64 解码\n\t\tlet byteString = atob(base64.split(',')[1]);\n\t\t//创建缓冲数组\n\t\tlet arrayBuffer = new ArrayBuffer(byteString.length);\n\t\t//创建视图\n\t\tlet intArray = new Uint8Array(arrayBuffer);\n\t\tfor (let i = 0; i < byteString.length; i++) {\n\t\t\tintArray[i] = byteString.charCodeAt(i);\n\t\t}\n\t\tresolve(URL.createObjectURL(new Blob([intArray], {\n\t\t\ttype: mimeString\n\t\t})))\n\t\t// #endif\n\n\t\t// #ifdef APP-PLUS\n\t\tconst bitmap = new plus.nativeObj.Bitmap('bitmap' + Date.now())\n\t\tbitmap.loadBase64Data(base64, () => {\n\t\t\tif (!format) {\n\t\t\t\treject(new Error('ERROR_BASE64SRC_PARSE'))\n\t\t\t}\n\t\t\tconst time = new Date().getTime();\n\t\t\tconst filePath = `_doc/uniapp_temp/${time}.${format}`\n\t\t\tbitmap.save(filePath, {},\n\t\t\t\t() => {\n\t\t\t\t\tbitmap.clear()\n\t\t\t\t\tresolve(filePath)\n\t\t\t\t},\n\t\t\t\t(error) => {\n\t\t\t\t\tbitmap.clear()\n\t\t\t\t\treject(error)\n\t\t\t\t})\n\t\t}, (error) => {\n\t\t\tbitmap.clear()\n\t\t\treject(error)\n\t\t})\n\t\t// #endif\n\t})\n}\n\n/**\n * 路径转base64\n * @param {Object} string\n */\nexport function pathToBase64(path) {\n\tif (/^data:/.test(path)) return path\n\treturn new Promise((resolve, reject) => {\n\t\t// #ifdef H5\n\t\tlet image = new Image();\n\t\timage.setAttribute(\"crossOrigin\", 'Anonymous');\n\t\timage.onload = function() {\n\t\t\tlet canvas = document.createElement('canvas');\n\t\t\tcanvas.width = this.naturalWidth;\n\t\t\tcanvas.height = this.naturalHeight;\n\t\t\tcanvas.getContext('2d').drawImage(image, 0, 0);\n\t\t\tlet result = canvas.toDataURL('image/png')\n\t\t\tresolve(result);\n\t\t\tcanvas.height = canvas.width = 0\n\t\t}\n\t\timage.src = path + '?v=' + Math.random()\n\t\timage.onerror = (error) => {\n\t\t\treject(error);\n\t\t};\n\t\t// #endif\n\n\t\t// #ifdef MP\n\t\tif (uni.canIUse('getFileSystemManager')) {\n\t\t\tuni.getFileSystemManager().readFile({\n\t\t\t\tfilePath: path,\n\t\t\t\tencoding: 'base64',\n\t\t\t\tsuccess: (res) => {\n\t\t\t\t\tresolve('data:image/png;base64,' + res.data)\n\t\t\t\t},\n\t\t\t\tfail: (error) => {\n\t\t\t\t\tconsole.error({error, path})\n\t\t\t\t\treject(error)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t\t// #endif\n\n\t\t// #ifdef APP-PLUS\n\t\tplus.io.resolveLocalFileSystemURL(getLocalFilePath(path), (entry) => {\n\t\t\tentry.file((file) => {\n\t\t\t\tconst fileReader = new plus.io.FileReader()\n\t\t\t\tfileReader.onload = (data) => {\n\t\t\t\t\tresolve(data.target.result)\n\t\t\t\t}\n\t\t\t\tfileReader.onerror = (error) => {\n\t\t\t\t\treject(error)\n\t\t\t\t}\n\t\t\t\tfileReader.readAsDataURL(file)\n\t\t\t}, reject)\n\t\t}, reject)\n\t\t// #endif\n\t})\n}\n\n\n\nexport function getImageInfo(path, useCORS) {\n\tconst isCanvas2D = this && this.canvas && this.canvas.createImage\n\treturn new Promise(async (resolve, reject) => {\n\t\t// let time = +new Date()\n\t\tlet src = path.replace(/^@\\//,'/')\n\t\tif (cache[path] && cache[path].errMsg) {\n\t\t\tresolve(cache[path])\n\t\t} else {\n\t\t\ttry {\n\t\t\t\t// #ifdef MP || APP-PLUS\n\t\t\t\tif (isBase64(path) && (isCanvas2D ? isPC : true)) {\n\t\t\t\t\tsrc = await base64ToPath(path)\n\t\t\t\t}\n\t\t\t\t// #endif\n\t\t\t\t// #ifdef H5\n\t\t\t\tif(useCORS) {\n\t\t\t\t\tsrc = await pathToBase64(path)\n\t\t\t\t}\n\t\t\t\t// #endif\n\t\t\t} catch (error) {\n\t\t\t\treject({\n\t\t\t\t\t...error,\n\t\t\t\t\tsrc\n\t\t\t\t})\n\t\t\t}\n\t\t\t// #ifndef APP-NVUE\n\t\t\tif(isCanvas2D && !isPC) {\n\t\t\t\tconst img = this.canvas.createImage()\n\t\t\t\timg.onload = function() {\n\t\t\t\t\tconst image = {\n\t\t\t\t\t\tpath: img,\n\t\t\t\t\t\twidth:  img.width,\n\t\t\t\t\t\theight:  img.height\n\t\t\t\t\t}\n\t\t\t\t\tcache[path] = image\n\t\t\t\t\tresolve(cache[path])\n\t\t\t\t}\n\t\t\t\timg.onerror = function(err) {\n\t\t\t\t\treject({err,path})\n\t\t\t\t}\n\t\t\t\timg.src = src\n\t\t\t\treturn\n\t\t\t}\n\t\t\t// #endif\n\t\t\tuni.getImageInfo({\n\t\t\t\tsrc,\n\t\t\t\tsuccess: (image) => {\n\t\t\t\t\tconst localReg = /^\\.|^\\/(?=[^\\/])/;\n\t\t\t\t\t// #ifdef MP-WEIXIN || MP-BAIDU || MP-QQ || MP-TOUTIAO\n\t\t\t\t\timage.path = localReg.test(src) ?  `/${image.path}` : image.path;\n\t\t\t\t\t// #endif\n\t\t\t\t\tif(isCanvas2D) {\n\t\t\t\t\t\tconst img = this.canvas.createImage()\n\t\t\t\t\t\timg.onload = function() {\n\t\t\t\t\t\t\timage.path = img\n\t\t\t\t\t\t\tcache[path] = image\n\t\t\t\t\t\t\tresolve(cache[path])\n\t\t\t\t\t\t}\n\t\t\t\t\t\timg.onerror = function(err) {\n\t\t\t\t\t\t\treject({err,path})\n\t\t\t\t\t\t}\n\t\t\t\t\t\timg.src = src\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\t// #ifdef APP-PLUS\n\t\t\t\t\t// console.log('getImageInfo', +new Date() - time)\n\t\t\t\t\t// ios 比较严格 可能需要设置跨域\n\t\t\t\t\tif(uni.getSystemInfoSync().osName == 'ios' && useCORS) {\n\t\t\t\t\t\tpathToBase64(image.path).then(base64 => {\n\t\t\t\t\t\t\timage.path = base64\n\t\t\t\t\t\t\tcache[path] = image\n\t\t\t\t\t\t\tresolve(cache[path])\n\t\t\t\t\t\t}).catch(err => {\n\t\t\t\t\t\t\tconsole.error({err, path})\n\t\t\t\t\t\t\treject({err,path})\n\t\t\t\t\t\t})\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\t// #endif\n\t\t\t\t\tcache[path] = image\n\t\t\t\t\tresolve(cache[path])\n\t\t\t\t},\n\t\t\t\tfail(err) {\n\t\t\t\t\tconsole.error({err, path})\n\t\t\t\t\treject({err,path})\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t})\n}\n\n\n// #ifdef APP-PLUS\nconst getLocalFilePath = (path) => {\n\tif (path.indexOf('_www') === 0 || path.indexOf('_doc') === 0 || path.indexOf('_documents') === 0 || path\n\t\t.indexOf('_downloads') === 0) {\n\t\treturn path\n\t}\n\tif (path.indexOf('file://') === 0) {\n\t\treturn path\n\t}\n\tif (path.indexOf('/storage/emulated/0/') === 0) {\n\t\treturn path\n\t}\n\tif (path.indexOf('/') === 0) {\n\t\tconst localFilePath = plus.io.convertAbsoluteFileSystem(path)\n\t\tif (localFilePath !== path) {\n\t\t\treturn localFilePath\n\t\t} else {\n\t\t\tpath = path.substr(1)\n\t\t}\n\t}\n\treturn '_www/' + path\n}\n// #endif\n\n\n"],"names":["uni","wx"],"mappings":"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"}