{"version":3,"file":"reply.js","sources":["pages/detail/reply.vue","../前端资料/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvZGV0YWlsL3JlcGx5LnZ1ZQ"],"sourcesContent":["<!-- ‘评论’页面 -->\r\n<template>\n\t<view class=\"replyLayout\">\n\t\t<z-paging ref=\"paging\" v-model=\"replyList\" @query=\"queryList\" empty-view-text=\"抢先回复\" empty-view-img=\"http://cdn.uviewui.com/uview/empty/comment.png\">\n\t\t\t<view class=\"outer\">\n\t\t\t\t<view class=\"body\">\n\t\t\t\t\t<comment-item :item=\"currentReply\" :toplevel=\"true\"></comment-item>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"list\">\n\t\t\t\t\t<view class=\"row\" v-for=\"item in replyList\" :key=\"item._id\">\n\t\t\t\t\t\t<comment-item :item=\"item\" :reply=\"true\" @reply=\"clickComment\"></comment-item>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view v-if=\"!replyList.length && !noData\" style=\"padding:60rpx\">\n\t\t\t\t\t<uni-load-more status=\"loading\" :showText=\"false\"></uni-load-more>\n\t\t\t\t</view>\n\t\t\t\t\n\t\t\t</view>\t\n\t\t\t\n\t\t\t<template #bottom>\n\t\t\t\t<view class=\"replyBar\" @click=\"clickReply\">\n\t\t\t\t\t<view class=\"out\">\n\t\t\t\t\t\t<view class=\"left\">发一条友好的评论吧</view>\n\t\t\t\t\t\t<view class=\"right\">\n\t\t\t\t\t\t\t<uni-icons type=\"paperplane\" size=\"26\" color=\"#333\"></uni-icons>\n\t\t\t\t\t\t</view>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"safe-area-bottom\" :style=\"{background:'#fff'}\"></view>\n\t\t\t\t</view>\n\t\t\t</template>\t\t\t\n\t\t</z-paging>\n\t</view>\n\t\n\t<uni-popup type=\"bottom\" ref=\"commentPopup\">\n\t\t<comment-reply ref=\"commentRef\"  :source=\"source\" @success=\"replySuccess\"></comment-reply>\n\t</uni-popup>\n</template>\n\n<script setup>\nimport { ref ,getCurrentInstance, nextTick} from 'vue';\nimport {onUnload} from \"@dcloudio/uni-app\"\nimport { showToast } from '../../utils/common';\nconst currentReply = ref(uni.getStorageSync(\"currentReply\") || {});\nconst current_id = uniCloud.getCurrentUserInfo().uid;\nconst commentPopup = ref(null);\nconst paging = ref(null);\nconst db = uniCloud.database();\nconst dbCmd = db.command;\nconst $ = dbCmd.aggregate;\nconst replyList = ref([]);\nconst noData = ref(false);\nconst source =ref({\n\tsoup_id:currentReply.value.soup_id,\n\tcomment_type:1,\n\treply_parent_id:currentReply.value._id,\n\treply_user_id:currentReply.value.userInfo._id,\n\treply_comment_id:currentReply.value._id,\n\treply_user_name:currentReply.value.userInfo.username\n});\nconst commentRef = ref(null);\nconst queryList =(pageNo, pageSize)=>{\n\tgetReply(pageNo, pageSize)\n}\n\nuni.$on(\"commentRemove\",()=>{\n\tnextTick(()=>{\n\t\tpaging.value.refresh();\n\t})\t\n})\n\nconst getReply =async (pageNo, pageSize)=>{\n\tlet skip = (pageNo - 1) * pageSize;\n\tlet {result:{errCode,data}} = await db.collection(\"soup-comments\").aggregate()\n\t.match({\n\t\tsoup_id:currentReply.value.soup_id,\t\t\n\t\tcomment_type:1,\n\t\treply_parent_id:currentReply.value._id\n\t})\n\t.lookup({\n\t\tfrom: \"uni-id-users\",\n\t\tlet: {\n\t\t\tuid: '$user_id'\n\t\t},\n\t\tpipeline: $.pipeline().match(dbCmd.expr($.eq(['$_id', '$$uid']))).project({\n\t\t\tusername: 1,\n\t\t\tavatar: 1\n\t\t}).done(),\n\t\tas: \"userInfo\"\n\t})\n\t.lookup({\n\t\tfrom: \"soup-comments\",\n\t\tlet: {\n\t\t\treply_comment_id: '$reply_comment_id',\n\t\t\treply_parent_id:'$reply_parent_id'\n\t\t},\n\t\tpipeline: $.pipeline()\n\t\t.match(dbCmd.expr(\n\t\t\t$.and([\n\t\t\t\t$.neq([\"$$reply_comment_id\",\"$$reply_parent_id\"]),\n\t\t\t\t$.eq(['$_id', '$$reply_comment_id'])\n\t\t\t])\t\t\n\t\t))\n\t\t.lookup({\n\t\t\tfrom: \"uni-id-users\",\n\t\t\tlet: {\n\t\t\t\tuid: '$user_id'\n\t\t\t},\n\t\t\tpipeline: $.pipeline().match(dbCmd.expr($.eq(['$_id', '$$uid']))).project({\n\t\t\t\tusername: 1\n\t\t\t}).done(),\n\t\t\tas: \"userInfo\"\n\t\t})\n\t\t.project({\n\t\t\tcomment_content: $.cond({\n\t\t\t\tif:$.eq(['$is_delete',true]),\n\t\t\t\tthen:\"已被删除\",\n\t\t\t\telse:'$comment_content'\n\t\t\t}),\n\t\t\tuserInfo:$.arrayElemAt(['$userInfo', 0])\n\t\t}).done(),\n\t\tas: \"replyInfo\"\n\t})\n\t.lookup({\n\t\tfrom: \"soup-like\",\n\t\tlet: {\n\t\t\tcommentID: '$_id'\n\t\t},\n\t\tpipeline: $.pipeline().match(\t\t\t\t\n\t\tdbCmd.expr(\n\t\t\t$.and([\t\t\t\t\t\n\t\t\t\t$.eq([currentReply.value.soup_id,'$soup_id']),\n\t\t\t\t$.eq(['$$commentID','$comment_id']),\n\t\t\t\t$.eq(['$user_id',current_id])\n\t\t\t])\n\t\t)).count('length')\n\t\t.done(),\n\t\tas: \"likeState\"\n\t})\n\t.sort({comment_date:-1})\n\t.skip(skip)\n\t.limit(pageSize)\n\t.project({\t\n\t\tis_delete:1,\n\t\tisLike:$.cond({\n\t\t\tif:$.gt([$.arrayElemAt(['$likeState.length',0]),0]),\n\t\t\tthen:true,\n\t\t\telse:false\n\t\t}),\n\t\tlike_count: 1,\n\t\tcomment_count: 1,\n\t\tcomment_type: 1,\n\t\tcomment_content: $.cond({\n\t\t\tif:$.eq(['$is_delete',true]),\n\t\t\tthen:\"已被删除\",\n\t\t\telse:'$comment_content'\n\t\t}),\n\t\tsoup_id: 1,\n\t\tcomment_date: 1,\n\t\tuserInfo: $.arrayElemAt(['$userInfo', 0]),\n\t\treplyInfo:$.arrayElemAt(['$replyInfo', 0]),\n\t})\n\t.end();\n\tconsole.log(data);\t\n\tpaging.value.complete(data);\n\tif(data.length==0) noData.value = true;\n}\n\n\n\nconst clickReply = ()=>{\n\tcommentPopup.value.open();\n\tcommentRef.value.focusFn();\n}\n\nconst clickComment = (e)=>{\n\tclickReply();\n\tsource.value = {\n\t\t...source.value,\n\t\treply_user_id:e.userInfo._id,\n\t\treply_comment_id:e._id,\n\t\treply_user_name:e.userInfo.username\t\t\n\t}\n}\n\n\n//发布成功后的回调\nconst replySuccess = ()=>{\t\n\tshowToast(\"发布成功\")\n\tcommentPopup.value.close();\n\tpaging.value.refresh();\n\tsource.value = {\n\t\t...source.value,\n\t\treply_user_id:currentReply.value.userInfo._id,\n\t\treply_comment_id:currentReply.value._id,\n\t\treply_user_name:currentReply.value.userInfo.username\n\t}\n}\n\n\nonUnload(()=>{\n\tuni.removeStorageSync(\"currentReply\")\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.replyLayout{\n\t.body{\n\t\tpadding:30rpx 0;\n\t\tborder-bottom:12rpx solid #F7F7F7;\n\t}\n\t.list{\n\t\t.row{\n\t\t\tborder-bottom:1px solid #F7F7F7;\n\t\t}\n\t}\n\t.replyBar{\n\t\tpadding:30rpx;\n\t\tborder-top: 2rpx solid #e4e4e4;\n\t\tbackground: #fff;\n\t\t.out{\n\t\t\tdisplay: flex;\n\t\t\tjustify-content: space-between;\n\t\t\talign-items: center;\n\t\t\t.left{\n\t\t\t\tflex:1;\n\t\t\t\theight: 70rpx;\n\t\t\t\tbackground: #f7f7f7;\n\t\t\t\tborder-radius: 70rpx;\n\t\t\t\tpadding:0 20rpx;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tcolor:#999;\n\t\t\t\tmargin-right:30rpx;\n\t\t\t}\n\t\t}\n\t}\n}\n</style>\n","import MiniProgramPage from 'C:/Users/DELL/Desktop/chickensoup/pages/detail/reply.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","uniCloud","nextTick","showToast","onUnload"],"mappings":"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"}