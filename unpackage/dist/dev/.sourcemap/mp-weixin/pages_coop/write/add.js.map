{"version":3,"file":"add.js","sources":["pages_coop/write/add.vue","../前端资料/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXNfY29vcFx3cml0ZVxhZGQudnVl"],"sourcesContent":["<template>\n\t<view class=\"writePage\">\n\n\t\t<view class=\"topMenu\">\n\t\t\t<view class=\"left text\" @click=\"goback\">\n\t\t\t\t取消\n\t\t\t</view>\n\t\t\t<view class=\"right\">\n\t\t\t\t<!-- <view class=\"preview text\">预览</view> -->\n\t\t\t\t<view class=\"submit text\" :class=\"submitState?'active':''\" @click=\"onSubmit\">发布</view>\n\t\t\t</view>\n\t\t</view>\n\n\t\t<view class=\"content\">\n\t\t\t<textarea class=\"textarea\" placeholder=\"说点什么吧...\" auto-height :maxlength=\"600\" v-model=\"formData.content\"></textarea>\n\t\t</view>\n\n\t\t<view class=\"pics\">\n\t\t\t<view class=\"item\" v-for=\"(item,index) in formData.imageList\" :key=\"item.id\">\n\t\t\t\t<image :src=\"item.src\" mode=\"aspectFill\" class=\"pic\" @click=\"previewImage(item,index)\"></image>\t\t\t\t\n\t\t\t\t<view class=\"close\" v-if=\"item.status !=0\" @click=\"delImage(item, index)\">×</view>\n\t\t\t\t<view class=\"progress\" v-if=\"item.status === 1\">{{item.progress}}%</view>\n\t\t\t</view>\n\n\t\t\t<view class=\"item add\" @click=\"addImages\">+</view>\n\t\t</view>\n\t</view>\n</template>\n\n<script setup>\n\timport {\n\t\tcomputed,\n\t\tref\n\t} from 'vue';\n\timport dayjs from \"dayjs\";\t\n\timport {useUserStore} from \"@/stores/user.js\"\n\tconst userStore = useUserStore();\n\tconst formData = ref({\n\t\tcontent:\"\",\n\t\timageList:[],\n\t\tstatus:0\n\t})\n\tconst maxNumber = ref(9);\n\tconst uniCloudStorageExtCo = uniCloud.importObject(\"ext-storage-co\", {\n\t\tcustomUI: true\n\t});\n\t\n\tconst db = uniCloud.database();\n\tconst secCheckObj = uniCloud.importObject(\"secCheckContent\",{customUI:true});\n\t\n\t\n\t//判断发布状态\n\tconst submitState = computed(()=>{\n\t\treturn formData.value.content.length>0 ||(formData.value.imageList.length>0 && formData.value.imageList.every(item => item.progress === 100));\n\t})\n\t\n\n\t//点击添加图片\n\tconst addImages = () => {\n\t\tlet checkNumber = maxNumber.value - formData.value.imageList.length;\n\t\tuni.chooseImage({\n\t\t\tcount: checkNumber,\n\t\t\tsizeType: ['original', 'compressed '],\n\t\t\tsourceType: ['album', 'camera'],\n\t\t\tsuccess: res => {\n\t\t\t\tlet count = checkNumber <= res.tempFilePaths.length ? checkNumber : res.tempFilePaths\n\t\t\t\t\t.length\t\t\t\t\n\t\t\t\tfor (let i = 0; i < count; i++) {\n\t\t\t\t\tformData.value.imageList.push({\n\t\t\t\t\t\tsrc: res.tempFilePaths[i],\n\t\t\t\t\t\turl: '',\n\t\t\t\t\t\tprogress: 0,\n\t\t\t\t\t\tstatus: 0,\n\t\t\t\t\t\tid: Date.now() + \"_\" + i\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\tupload()\n\t\t\t}\n\t\t})\n\t}\n\n\n\t//上传图片\n\tconst upload = async () => {\t\t\n\t\tlet promises = [];\n\t\tlet readyFileCount;\n\t\tformData.value.imageList\n\t\t.filter((e) => e.status === 0 && (readyFileCount=formData.value.imageList.length))\n\t\t.forEach(item=>{\n\t\t\treadyFileCount -=1;\n\t\t\titem.status = 1;\n\t\t\tlet promise = uniCloudStorageExtCo.getUploadFileOptions({\n\t\t\t\tcloudPath: `chickenSoup/${dayjs().format(\"YYYYMMDD\")}/${item.id}.jpg`, // 支持自定义目录\n\t\t\t})\n\t\t\tpromises.push(promise);\n\t\t})\n\t\t\n\t\tlet result = await Promise.all(promises);\n\t\tresult.forEach((item,index)=>{\n\t\t\tlet currentImg = formData.value.imageList[index+readyFileCount];\n\t\t\tconst uploadTask = uni.uploadFile({\n\t\t\t  ...item.uploadFileOptions, // 上传文件所需参数\n\t\t\t  filePath:currentImg.src, // 本地文件路径\n\t\t\t  success: () => {\n\t\t\t    const res = {\n\t\t\t      cloudPath: item.cloudPath, // 文件云端路径\n\t\t\t      fileID: item.fileID, // 文件ID\n\t\t\t      fileURL: item.fileURL, // 文件URL（如果是私有权限，则此URL是无法直接访问的）\n\t\t\t    };\n\t\t\t    // 数据库里可直接保存 fileURL 或 fileID\n\t\t\t    console.log(\"上传成功\", res);\n\t\t\t    currentImg.progress = 100;\n\t\t\t    currentImg.status = 2;\n\t\t\t    currentImg.url = res.fileURL;\n\t\t\t  },\n\t\t\t  fail: (err) => {\n\t\t\t    currentImg.status = -1;\n\t\t\t\tcurrentImg.progress = 99;\n\t\t\t  },\n\t\t\t});\t\t\t\t\n\t\t\t// 监听上传进度\n\t\t\tuploadTask.onProgressUpdate((res) => {\n\t\t\t  currentImg.progress = res.progress;\n\t\t\t});\t\t\t\t\n\t\t})\n\t};\n\n\n\t//删除图片\n\tconst delImage = (item, index)=>{\n\t\tuniCloudStorageExtCo.deleteFile([formData.value.imageList[index].url]);\n\t\tformData.value.imageList.splice(index, 1);\t\t\n\t}\n\n\n\t//预览图片\n\tconst previewImage = (item,index)=>{\n\t\tlet previews = formData.value.imageList.map(item=>item.src);\n\t\tuni.previewImage({\n\t\t  urls: previews,\n\t\t  current: index\n\t\t})\n\t}\n\t\n\t//提交圈子\n\tconst onSubmit = async ()=>{\n\t\t\t\t\t\t\n\t\tuni.showLoading({\n\t\t\ttitle:\"提交中\",\n\t\t\tmask:true\n\t\t})\n\t\tif(!submitState.value) return;\n\t\tif(formData.value.content){\n\t\t\tlet secRes = await secCheckObj.textSecCheck(formData.value.content,userStore.userInfo.openid);\t\n\t\t\tif(secRes.code){\n\t\t\t\tuni.hideLoading()\n\t\t\t\tuni.showModal({\n\t\t\t\t\ttitle:secRes.errMsg,\n\t\t\t\t\tcontent:`发布内容存在\"${secRes.result.label}\"问题,请重新编辑后发布!`,\n\t\t\t\t\tshowCancel:false\n\t\t\t\t})\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(!formData.value.imageList.length) formData.value.status=1;\n\t\t\t\t\n\t\t\n\t\tlet res = await db.collection(\"chicken-coop\").add({\n\t\t\tcontent:formData.value.content,\n\t\t\tpicurls:formData.value.imageList.map(item=>item.url),\n\t\t\tstatus:formData.value.status\n\t\t})\n\t\t\n\t\tif(res.result.errCode==0){\n\t\t\tlet coop_id = res.result.id;\n\t\t\tlet picurls = formData.value.imageList.map(item=>item.url);\t\t\n\t\t\tif(picurls.length){\n\t\t\t\tlet row = await secCheckObj.imgSecCheck({picurls,openid:userStore.userInfo.openid,coop_id});\t\t\t\t\n\t\t\t\t\n\t\t\t}\n\t\t\tuni.showToast({\n\t\t\t\ttitle:\"发布成功，等待审核\",\n\t\t\t\ticon:\"none\",\n\t\t\t\tmask:true\n\t\t\t})\n\t\t\tsetTimeout(()=>{\n\t\t\t\tgoback();\n\t\t\t},1000)\n\t\t\t\n\t\t}\t\t\n\t\t\n\t\t\n\t}\n\n\n\n\t//返回上个页面\n\tconst goback = ()=>{\n\t\tuni.navigateBack()\n\t}\n\n</script>\n\n<style lang=\"scss\" scoped>\n\t.writePage {\n\t\t.topMenu {\n\t\t\tborder-bottom: 1rpx solid #F8F8F8;\n\t\t\theight: 90rpx;\n\t\t\tdisplay: flex;\n\t\t\tjustify-content: space-between;\n\t\t\talign-items: center;\n\n\t\t\t.text {\n\t\t\t\tfont-size: 32rpx;\n\t\t\t\tpadding: 10rpx 30rpx;\n\t\t\t}\n\n\t\t\t.left {}\n\n\t\t\t.right {\n\t\t\t\tdisplay: flex;\n\t\t\t\tcolor: #a0a0a0;\n\n\t\t\t\t.submit {\n\t\t\t\t\tfont-weight: 600;\n\n\t\t\t\t\t&.active {\n\t\t\t\t\t\tcolor: #3B3B98;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t.content {\n\t\t\tpadding: 30rpx;\n\n\t\t\t.textarea {\n\t\t\t\tfont-size: 38rpx;\n\t\t\t\twidth: 100%;\n\t\t\t\tline-height: 1.7em;\n\t\t\t\tmax-height: 600rpx;\n\t\t\t}\n\t\t}\n\n\t\t.pics {\n\t\t\tdisplay: grid;\n\t\t\tpadding: 30rpx;\n\t\t\tgrid-template-columns: repeat(3, 1fr);\n\t\t\tgap: 10rpx;\n\n\t\t\t.item {\n\t\t\t\taspect-ratio: 1 / 1;\n\t\t\t\tbackground: #F4F5F7;\n\t\t\t\tposition: relative;\n\n\t\t\t\t.pic {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t\tdisplay: block;\n\t\t\t\t}\n\n\t\t\t\t.close {\n\t\t\t\t\tline-height: 50rpx;\n\t\t\t\t\tbackground: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tleft: 0;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\ttext-align: right;\n\t\t\t\t\tcolor: #fff;\n\t\t\t\t\tfont-size: 40rpx;\n\t\t\t\t\tpadding-right: 10rpx;\n\t\t\t\t}\n\n\t\t\t\t.progress {\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\ttop: 0;\n\t\t\t\t\tleft: 0;\n\t\t\t\t\tbackground: rgba(0, 0, 0, 0.6);\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 100%;\n\t\t\t\t\tcolor: #fff;\n\t\t\t\t\tfont-size: 26rpx;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t}\n\n\t\t\t\t&.add {\n\t\t\t\t\tbackground: #F4F5F7;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t\tfont-size: 100rpx;\n\t\t\t\t\tfont-weight: 100;\n\t\t\t\t\tcolor: #a5a6a8;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\n\t}\n</style>","import MiniProgramPage from 'C:/Users/DELL/Desktop/chickensoup/pages_coop/write/add.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","ref","uniCloud","computed","uni","dayjs","item"],"mappings":"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"}