{"version":3,"file":"edit.js","sources":["pages_self/soup/edit.vue","../前端资料/HBuilderX.4.57.2025032507/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXNfc2VsZlxzb3VwXGVkaXQudnVl"],"sourcesContent":["<!-- 编辑鸡汤页面 就是点进熬制鸡汤再点任何一个鸡汤就行 -->\r\n<template>\n\t<view v-if=\"formData.status != undefined && !isAdminRole()\">\n\t\t<uni-notice-bar\n\t\t:background-color=\"useStateFormat.bgColor\"\n\t\t:color=\"useStateFormat.color\" \n\t\tshowIcon \n\t\t:text=\"`通知：${useStateFormat.text}，${(formData.status == 0 || formData.status == 1)?'不允许再次编辑':formData.feedback+'，修改后可再次提交'}。`\"></uni-notice-bar>\n\t</view>\n\t\n\t<view class=\"editLayout\">\r\n\t\t<!-- 根据管理员权限进行编辑 -->\n\t\t<view class=\"row\" v-if=\"formData.user_id && isAdminRole()\">\n\t\t\t<view class=\"head\">\n\t\t\t\t<view class=\"title\">发布者</view>\t\t\t\t\n\t\t\t</view>\r\n\t\t\t\n\t\t\t<view class=\"body\">\n\t\t\t\t<view class=\"userinfo\">\n\t\t\t\t\t<image class=\"pic\" :src=\"formData?.user_id[0]?.avatar || '../../static/images/defAvatar.png'\" mode=\"aspectFill\"></image>\n\t\t\t\t\t<text class=\"name\">{{formData?.user_id[0]?.username || '匿名'}}</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t\n\t\t\n\t\t\n\t\t\n\t\t<view class=\"row\">\n\t\t\t<view class=\"head\">\n\t\t\t\t<view class=\"title\">鸡汤类型</view>\t\t\t\t\n\t\t\t</view>\n\t\t\t<view class=\"body\">\n\t\t\t\t<radio-group @change=\"radioChange\">\n\t\t\t\t\t<label class=\"radio\">\n\t\t\t\t\t\t<radio :disabled=\"disabled || statusDisabled\" :value=\"0\" color=\"#4F9153\" :checked=\"formData.soup_type==0\"></radio>毒鸡汤\n\t\t\t\t\t</label>\n\t\t\t\t\t<label class=\"radio\">\n\t\t\t\t\t\t<radio :disabled=\"disabled || statusDisabled\" :value=\"1\" color=\"#f83162\" :checked=\"formData.soup_type==1\"></radio>心灵鸡汤\n\t\t\t\t\t</label>\n\t\t\t\t</radio-group>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<view class=\"row\">\n\t\t\t<view class=\"head\">\n\t\t\t\t<view class=\"title\">鸡汤内容</view>\n\t\t\t\t<text class=\"subTitle\">\n\t\t\t\t\t1.一行不超过12个字，最多5行\\n\n\t\t\t\t\t2.毒鸡汤、心灵鸡汤、有感而发均可\\n\n\t\t\t\t\t3.提交后管理员审核，有可能会微调\n\t\t\t\t</text>\n\t\t\t</view>\n\t\t\t<view class=\"body\">\n\t\t\t\t<textarea :disabled=\"disabled || statusDisabled\" v-model=\"formData.content\" class=\"soupConent\" placeholder=\"编写你的鸡汤吧~~\"></textarea>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t\n\t\t<view class=\"row\">\n\t\t\t<view class=\"head\">\n\t\t\t\t<view class=\"title\">添加出处</view>\n\t\t\t\t<text class=\"subTitle\">\n\t\t\t\t\t如果是摘抄的，建议添加出处\n\t\t\t\t</text>\n\t\t\t</view>\n\t\t\t<view class=\"body\">\n\t\t\t\t<input :disabled=\"disabled || statusDisabled\" v-model=\"formData.from\" class=\"fromIpt\" type=\"text\" placeholder=\"如:《红楼梦》\">\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t\n\t\t<view class=\"row\" v-if=\"isAdminRole() && formData._id\">\n\t\t\t<view class=\"head\">\n\t\t\t\t<view class=\"title\">鸡汤状态</view>\t\t\t\t\n\t\t\t</view>\n\t\t\t<view class=\"body\">\n\t\t\t\t<radio-group @change=\"statusChange\"> <!-- radio是单选框 -->\n\t\t\t\t\t<label class=\"radio\" v-for=\"item in stateLists\" :key=\"item.value\">\n\t\t\t\t\t\t<view><radio :color=\"item.color\" :value=\"item.value\" \n\t\t\t\t\t\t:checked=\"item.value == formData.status\" />\n\t\t\t\t\t\t<text>{{item.text}}</text></view> \n\t\t\t\t\t</label> \n\t\t\t\t</radio-group>\n\t\t\t\t<input v-if=\"formData.status===2\" :disabled=\"disabled || statusDisabled\" v-model=\"formData.feedback\" class=\"fromIpt\" type=\"text\" placeholder=\"请输入不通过的原因\">\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t\n\t\t<view class=\"row btnGroup\">\t\t\t\n\t\t\t<view class=\"body\">\n\t\t\t\t<button type=\"primary\" v-if=\"isAdminRole()\" @click=\"onSubmit\" :disabled=\"statusDisabled\">发布鸡汤</button> <!-- 根据是否是管理员决定是发布鸡汤还是提交审核 -->\n\t\t\t\t<button type=\"primary\" v-else @click=\"onSubmit\" :disabled=\"statusDisabled\">提交审核</button>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t</view>\n</template>\n\n<script setup>\nimport { ref,computed } from 'vue';\nimport {showToast,stateFormat,isAdminRole,stateLists} from \"@/utils/common.js\"\nimport {removeHtmlTags,formatDate} from \"@/utils/tools.js\"\nimport {onLoad} from \"@dcloudio/uni-app\"\nimport {useUserStore} from \"@/stores/user.js\"\nconst userStore = useUserStore();\nconst useStateFormat =  computed(()=>stateFormat(formData.value.status));\nconst soupScore = uniCloud.importObject(\"soup-score\")\nconst subscribemsg = uniCloud.importObject(\"subscribemsg\")\nconst db = uniCloud.database();\nconst formData = ref({\n\tsoup_type:0,\n\tcontent:\"\",\n\tfrom:\"\",\n\tfeedback:''\n})\nconst disabled = ref(false);\nconst statusDisabled = ref(false);\nlet id;\n\nonLoad((e)=>{\t\n\tid = e.id\n\tif(id){\n\t\tuni.showLoading({\n\t\t\ttitle:\"加载中...\",\n\t\t\tmask:true\n\t\t})\n\t\tgetDetail();\n\t\tuni.setNavigationBarTitle({\n\t\t\ttitle:\"编辑鸡汤\"\n\t\t})\n\t}\n})\n\n//鸡汤类型\nconst radioChange = (e)=>{\t\n\tformData.value.soup_type = Number(e.detail.value);\n}\n\n\n//审核状态修改\nconst statusChange = (e)=>{\t\n\tformData.value.status = Number(e.detail.value);\n\tif(formData.value.status!=2) formData.value.feedback = ''\n}\n\n\nconst onSubmit = async ()=>{\n\tif(!isAdminRole()){\n\t\tawait uni.requestSubscribeMessage({\n\t\t\ttmplIds: [\"B5Y1YX8q2WhPV1qSOD0lOlGenO2J5L79NKPWFUZMO5w\"]\t\t\n\t\t});\n\t}\t\n\t\n\ttry{\n\t\tdisabled.value = true;\n\t\tuni.showLoading({\n\t\t\ttitle:\"提交中\"\n\t\t})\n\t\tformData.value.content = removeHtmlTags(formData.value.content);\t\n\t\tif(formData.value.content===\"\") return showToast('鸡汤内容不能为空',\"none\",false);\t\t\n\t\tlet errCode,res\n\t\tlet {soup_type,status,content,from,feedback} = formData.value;\n\t\tlet _formData = {soup_type,status,content,from,feedback};\n\t\tif(id){\n\t\t\tif(!isAdminRole()) _formData.status = 0;\n\t\t\tif(isAdminRole()) _formData.review_uid = userStore.userInfo._id;\n\t\t\tres = await db.collection(\"soup-chicken\").doc(id).update(_formData);\t\t\t\n\t\t}else{\n\t\t\tif(isAdminRole()) formData.value.status = 1;\n\t\t\tres = await db.collection(\"soup-chicken\").add(formData.value);\n\t\t\t\n\t\t}\t\t\n\t\terrCode = res.result.errCode;\n\t\t\t\t\t\n\t\tif(errCode === 0){\n\t\t\tuni.$emit(\"soupUpdate\",{msg:\"更新了\"});\n\t\t\tshowToast(\"发表成功\",\"success\");\t\t\t\n\t\t\tsetTimeout(()=>uni.navigateBack(),1000)\n\t\t\tupdataSuccess(res.result.id)\n\t\t}\t\t\n\t}catch(e){\t\t\n\t\tconsole.log(e);\n\t\tshowToast(e.errMsg,\"error\")\n\t}finally{\n\t\tuni.hideLoading();\n\t\tdisabled.value = false;\n\t}\t\n\t\n}\n\n\nconst  updataSuccess = (soupID)=>{\t \n\t\t\n\tif(id || isAdminRole()){\t\n\t\tif(formData.value.status===1){\n\t\t\tlet {user_id:[{_id:user_id=uniCloud.getCurrentUserInfo().uid}={}]=[],_id:soup_id=soupID} = formData.value || {}\n\t\t\tsoupScore.soupAdd({user_id,soup_id})\n\t\t}\n\t}\n\tif(id && isAdminRole()){\r\n\t\t// 发送消息\n\t\tsubscribemsg.sendSubscribeMessage({\n\t\t\tuser_id:formData.value.user_id[0]._id,\n\t\t\tphrase2:useStateFormat.value.text,\n\t\t\ttime3:formatDate(Date.now()),\n\t\t\tthing4:formData.value.feedback?formData.value.feedback:\"点击进入小程序查看\"\n\t\t}).then(res=>{\n\t\t\tconsole.log(res);\n\t\t})\n\t}\t\n}\n\n\n//获取单条数据\nconst getDetail = async()=>{\n\t\n\tlet soupTemp = await db.collection(\"soup-chicken\").where({_id:id}).getTemp();\n\tlet userTemp = await db.collection(\"uni-id-users\").field(\"_id,username,avatar\").getTemp();\n\t\n\tlet {result:{errCode,data}} = await db.collection(soupTemp,userTemp).get();\n\t\t\n\tconsole.log(data[0]);\n\tif(errCode === 0){\n\t\tformData.value = data[0]\n\t\tif(formData.value.status !==2 && !isAdminRole()) statusDisabled.value = true;\n\t}\n\tuni.hideLoading()\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.editLayout{\n\tpadding:30rpx;\n\t.row{\n\t\tpadding-bottom:30rpx;\n\t\t.head{\n\t\t\tpadding:20rpx 0;\n\t\t\t.title{\n\t\t\t\tfont-size: 34rpx;\n\t\t\t\tpadding-left:20rpx;\n\t\t\t\tposition: relative;\n\t\t\t\tpadding-bottom:6rpx;\n\t\t\t\t&::before{\n\t\t\t\t\tcontent: \"\";\n\t\t\t\t\tdisplay: block;\n\t\t\t\t\twidth: 8rpx;\n\t\t\t\t\theight: 30rpx;\n\t\t\t\t\tbackground: $brand-theme-color;\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\tleft:0;\n\t\t\t\t\ttop:calc(50% - 15rpx);\n\t\t\t\t\tborder-radius: 10rpx;\n\t\t\t\t}\n\t\t\t}\n\t\t\t.subTitle{\n\t\t\t\tfont-size: 26rpx;\n\t\t\t\tcolor:$text-font-color-3;\n\t\t\t}\n\t\t}\n\t\t.body{\n\t\t\t.userinfo{\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\t.pic{\n\t\t\t\t\twidth: 60rpx;\n\t\t\t\t\theight: 60rpx;\n\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t}\n\t\t\t\t.name{\n\t\t\t\t\tpadding-left:10rpx;\n\t\t\t\t}\n\t\t\t}\n\t\t\t.radio{\n\t\t\t\tmargin-right:30rpx;\n\t\t\t\tradio{\n\t\t\t\t\ttransform: scale(0.9);\n\t\t\t\t}\n\t\t\t}\n\t\t\t.soupConent{\n\t\t\t\tborder:1px solid $border-color;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 400rpx;\n\t\t\t\tbackground: #FCFCFC;\n\t\t\t\tpadding:20rpx;\n\t\t\t\tborder-radius: 10rpx;\n\t\t\t\tfont-size: 50rpx;\n\t\t\t\tline-height: 1.7em;\n\t\t\t}\n\t\t\t.fromIpt{\n\t\t\t\tborder:1px solid $border-color;\n\t\t\t\theight: 80rpx;\n\t\t\t\tpadding:0 20rpx;\n\t\t\t\tborder-radius: 10rpx;\n\t\t\t\tbackground: #FCFCFC;\n\t\t\t}\n\t\t}\n\t}\n\t\n\t.btnGroup{\n\t\tpadding-top:60rpx;\n\t}\n}\n\n[disabled]:not(button){\n\tcolor:#bbb;\n}\n</style>\n","import MiniProgramPage from 'C:/Users/DELL/Desktop/chickensoup/pages_self/soup/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","computed","stateFormat","uniCloud","ref","onLoad","uni","isAdminRole","removeHtmlTags","showToast","formatDate"],"mappings":"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"}